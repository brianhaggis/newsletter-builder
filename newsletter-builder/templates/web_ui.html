<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <title>Newsletter Builder - House of Hamill</title>
    <!-- Google Fonts for theme display fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=EB+Garamond:wght@400;600;700&family=Montserrat:wght@400;600;700&family=Oswald:wght@400;500;700&family=Playfair+Display:wght@400;700&family=Raleway:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <style>
        :root {
            --theme-header-bg: #1a1a1a;
            --theme-header-text: #ffffff;
            --theme-accent: #c9a227;
            --theme-accent-text: #1a1a1a;
            --theme-body-bg: #ffffff;
            --theme-preview-bg: #2a2a2a;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--theme-preview-bg);
            color: #333;
            min-height: 100vh;
            transition: background-color 0.3s ease;
        }

        /* Header */
        .header {
            background: var(--theme-header-bg);
            color: var(--theme-header-text);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--theme-accent);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .header h1 {
            font-family: Georgia, serif;
            font-size: 20px;
            font-weight: normal;
            letter-spacing: 2px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--theme-accent);
            color: var(--theme-accent-text);
            transition: background-color 0.3s ease;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: #333;
            color: #fff;
            border: 1px solid #555;
        }

        .btn-secondary:hover {
            background: #444;
        }

        /* Main container */
        .container {
            display: flex;
            min-height: calc(100vh - 100px);
        }

        /* Editor panel */
        .editor-panel {
            width: 40%;
            min-width: 350px;
            background: #f8f8f8;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }

        .editor-section {
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
        }

        .editor-section label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 6px;
        }

        .editor-section input[type="text"],
        .editor-section select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .editor-section input[type="text"]:focus,
        .editor-section select:focus,
        .editor-section textarea:focus {
            outline: none;
            border-color: #c9a227;
            box-shadow: 0 0 0 2px rgba(201, 162, 39, 0.2);
        }

        .body-editor {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .body-editor #body-editor {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .body-editor .ql-toolbar {
            border: none;
            border-bottom: 1px solid #ddd;
            background: #f8f8f8;
        }

        .body-editor .ql-container {
            border: none;
            flex: 1;
            font-family: Georgia, serif;
            font-size: 15px;
        }

        .body-editor .ql-editor {
            line-height: 1.6;
        }

        /* Preview panel */
        .preview-panel {
            flex: 1;
            background: var(--theme-preview-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            transition: background-color 0.3s ease;
        }

        .preview-container {
            background: #fff;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 740px;
            transition: all 0.3s ease;
        }

        .preview-container.mobile-preview {
            max-width: 360px;
            overflow: visible;
        }

        .preview-container iframe {
            width: 700px;
            border: none;
            display: block;
            margin: 0 auto;
            transform-origin: top left;
            transition: transform 0.3s ease;
        }

        .preview-container.mobile-preview iframe {
            transform: scale(0.514);
            width: 700px;
        }

        /* Preview mode toggle */
        .preview-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .preview-toggle button {
            padding: 6px 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            background: transparent;
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preview-toggle button:hover {
            border-color: rgba(255,255,255,0.5);
            color: #fff;
        }

        .preview-toggle button.active {
            background: var(--theme-accent);
            border-color: var(--theme-accent);
            color: var(--theme-accent-text);
        }

        /* Status indicator */
        .status {
            padding: 8px 20px;
            background: var(--theme-header-bg);
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }

        .status-dot.loading {
            background: var(--theme-accent);
            animation: pulse 1s infinite;
        }

        .status-dot.success {
            background: #4caf50;
        }

        .status-dot.error {
            background: #f44336;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Merch selector */
        .merch-select {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .merch-select select {
            flex: 1;
        }

        .merch-preview {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
            border: 1px solid #ddd;
        }

        /* Photo drop zone */
        .photo-drop-zone {
            border: 2px dashed #ccc;
            border-radius: 4px;
            padding: 10px;
            transition: all 0.2s;
        }

        .photo-drop-zone.drag-over {
            border-color: #c9a227;
            background: #fffbeb;
        }

        .photo-drop-zone input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .drop-hint {
            font-size: 11px;
            color: #888;
            text-align: center;
            margin: 8px 0;
        }

        .photo-preview {
            max-width: 100%;
            max-height: 120px;
            border-radius: 4px;
            display: block;
            margin-top: 8px;
        }

        .photo-preview[src=""], .photo-preview:not([src]) {
            display: none;
        }

        /* Help text */
        .help-text {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }

        /* Image insert modal */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1002;
        }

        .image-modal.hidden {
            display: none;
        }

        .image-modal-content {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            width: 450px;
            max-width: 90%;
        }

        .image-modal h3 {
            margin: 0 0 20px 0;
            font-size: 18px;
            color: #1a1a1a;
        }

        .image-modal label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
        }

        .image-modal input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .image-modal-dropzone {
            border: 2px dashed #ccc;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            color: #888;
            transition: all 0.2s;
        }

        .image-modal-dropzone.drag-over {
            border-color: #c9a227;
            background: #fffbeb;
        }

        .image-modal-dropzone img {
            max-width: 100%;
            max-height: 150px;
            margin-top: 10px;
            border-radius: 4px;
        }

        .image-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            background: #fff;
            padding: 30px 40px;
            border-radius: 8px;
            text-align: center;
        }

        .loading-spinner::before {
            content: '';
            display: block;
            width: 40px;
            height: 40px;
            margin: 0 auto 15px;
            border: 3px solid #eee;
            border-top-color: #c9a227;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #333;
            color: #fff;
            border-radius: 4px;
            font-size: 14px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: #4caf50;
        }

        .toast.error {
            background: #f44336;
        }

        /* Mobile tab toggle */
        .mobile-tabs {
            display: none;
            background: var(--theme-header-bg);
            padding: 0;
            transition: background-color 0.3s ease;
        }

        .mobile-tabs button {
            flex: 1;
            padding: 14px 20px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.7);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .mobile-tabs button.active {
            color: var(--theme-accent);
            border-bottom-color: var(--theme-accent);
            background: rgba(255, 255, 255, 0.1);
        }

        .mobile-tabs button:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 14px;
                letter-spacing: 1px;
            }

            .header-actions .btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .mobile-tabs {
                display: flex;
            }

            .container {
                flex-direction: column;
                min-height: auto;
            }

            .editor-panel {
                width: 100%;
                min-width: unset;
                border-right: none;
                border-bottom: 1px solid #ddd;
            }

            .editor-panel.hidden-mobile {
                display: none !important;
            }

            .preview-panel {
                width: 100%;
                min-height: 80vh;
                padding: 0;
                overflow-x: hidden;
            }

            .preview-panel.hidden-mobile {
                display: none !important;
            }

            .preview-container {
                width: 100% !important;
                max-width: 100% !important;
                box-shadow: none;
                transform: none !important;
            }

            .preview-container iframe {
                width: 100%;
            }

            .preview-toggle {
                display: none;
            }

            .body-editor .ql-container {
                min-height: 200px;
            }

            .editor-section {
                padding: 12px 15px;
            }

            .status {
                flex-direction: column;
                gap: 5px;
                text-align: center;
            }
        }

        @media (max-width: 500px) {
            .header {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }

            .header h1 {
                font-size: 12px;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>HOUSE OF HAMILL NEWSLETTER BUILDER</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="regenerateTourMap()">Update Map</button>
            <!-- Hidden for now - can re-enable later -->
            <button class="btn btn-secondary" onclick="refreshData()" style="display: none;">Refresh</button>
            <button class="btn btn-secondary" onclick="sendTestEmail()">Send Test</button>
            <!-- Hidden for now - can re-enable later -->
            <button class="btn btn-secondary" onclick="downloadHTML()" style="display: none;">Download</button>
            <button class="btn btn-primary" onclick="copyHTML()">Copy HTML</button>
        </div>
    </div>

    <div class="mobile-tabs">
        <button id="tab-edit" class="active" onclick="showMobileView('edit')">Edit</button>
        <button id="tab-preview" onclick="showMobileView('preview')">Preview</button>
    </div>

    <div class="container">
        <div class="editor-panel">
            <div class="editor-section">
                <label for="subject">Subject Line</label>
                <input type="text" id="subject" placeholder="Enter newsletter subject..." oninput="schedulePreviewUpdate()">
            </div>

            <div class="editor-section">
                <label for="tagline">Tagline</label>
                <input type="text" id="tagline" placeholder="Upcycled Celtic Folk" value="Upcycled Celtic Folk" oninput="schedulePreviewUpdate()">
                <div class="help-text">Appears below the band name in the header</div>
            </div>

            <div class="editor-section">
                <label for="photo-url">Header Photo</label>
                <div class="photo-drop-zone" id="photo-drop-zone">
                    <input type="text" id="photo-url" placeholder="Paste URL or drag image here..." value="{{ default_header_image }}" oninput="schedulePreviewUpdate()">
                    <div class="drop-hint">or drag & drop an image file</div>
                    <img id="photo-preview" class="photo-preview" src="{{ default_header_image }}" alt="">
                </div>
                <div class="help-text">Leave empty to skip header image</div>
            </div>

            <div class="editor-section">
                <label for="merch-select">Merch Spotlight</label>
                <div class="merch-select">
                    <select id="merch-select" onchange="schedulePreviewUpdate()">
                        <option value="">-- No merch spotlight --</option>
                    </select>
                    <img id="merch-preview-img" class="merch-preview" src="" alt="" style="display: none;">
                </div>
            </div>

            <div class="editor-section">
                <label for="theme-select">Color Theme</label>
                <select id="theme-select" onchange="schedulePreviewUpdate()">
                    <option value="">Loading themes...</option>
                </select>
            </div>

            <div class="editor-section">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; text-transform: none; font-size: 14px;">
                    <input type="checkbox" id="food-drive-toggle" onchange="schedulePreviewUpdate()" style="width: 18px; height: 18px; cursor: pointer;">
                    <span>Include Food Drive Promo</span>
                </label>
                <div class="help-text">Adds a block promoting the food drive volunteer program with free tickets</div>
            </div>

            <div class="editor-section body-editor">
                <label>Newsletter Body</label>
                <div id="body-editor"></div>
            </div>
        </div>

        <div class="preview-panel">
            <div class="preview-toggle">
                <button id="preview-desktop" class="active" onclick="setPreviewMode('desktop')">Desktop</button>
                <button id="preview-mobile" onclick="setPreviewMode('mobile')">Mobile</button>
            </div>
            <div class="preview-container" id="preview-container">
                <iframe id="preview-frame" title="Newsletter Preview"></iframe>
            </div>
        </div>
    </div>

    <div class="status">
        <div class="status-indicator">
            <div class="status-dot" id="status-dot"></div>
            <span id="status-text">Ready</span>
        </div>
        <span id="shows-count">Loading shows...</span>
    </div>

    <div class="loading-overlay hidden" id="loading-overlay">
        <div class="loading-spinner">Loading data...</div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Send Test Email Modal -->
    <div class="image-modal hidden" id="email-modal">
        <div class="image-modal-content">
            <h3>Send Test Email</h3>
            <label for="email-recipient-input">Recipient Email</label>
            <input type="email" id="email-recipient-input" placeholder="brianhaggis@gmail.com" value="brianhaggis@gmail.com">
            <div class="help-text" style="margin-bottom: 20px;">The test email will be sent to this address</div>
            <div class="image-modal-buttons">
                <button class="btn btn-secondary" onclick="closeEmailModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmSendTestEmail()">Send Test</button>
            </div>
        </div>
    </div>

    <!-- Image Insert Modal -->
    <div class="image-modal hidden" id="image-modal">
        <div class="image-modal-content">
            <h3>Insert Image</h3>
            <label for="image-url-input">Image URL</label>
            <input type="text" id="image-url-input" placeholder="https://...">

            <div class="image-modal-dropzone" id="image-modal-dropzone">
                Drop an image here, or enter URL above
                <img id="image-modal-preview" src="" alt="" style="display: none;">
            </div>

            <label for="image-link-input">Link URL (optional)</label>
            <input type="text" id="image-link-input" placeholder="https://... (makes image clickable)">

            <label for="image-caption-input">Caption (optional)</label>
            <input type="text" id="image-caption-input" placeholder="Enter image caption...">

            <div class="image-modal-buttons">
                <button class="btn btn-secondary" onclick="closeImageModal()">Cancel</button>
                <button class="btn btn-primary" onclick="insertImage()">Insert</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let shows = [];
        let merchItems = [];
        let themes = [];
        let selectedTheme = '';
        let tourMapUrl = null;
        let previewTimeout = null;
        const DEBOUNCE_MS = 300;

        // Elements
        const subjectInput = document.getElementById('subject');
        const taglineInput = document.getElementById('tagline');
        const photoUrlInput = document.getElementById('photo-url');
        const photoDropZone = document.getElementById('photo-drop-zone');
        const photoPreview = document.getElementById('photo-preview');
        const merchSelect = document.getElementById('merch-select');
        const merchPreviewImg = document.getElementById('merch-preview-img');
        const themeSelect = document.getElementById('theme-select');
        const previewFrame = document.getElementById('preview-frame');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const showsCount = document.getElementById('shows-count');
        const loadingOverlay = document.getElementById('loading-overlay');
        const toast = document.getElementById('toast');

        // Quill rich text editor
        let quillEditor = null;

        // Ridiculous filler texts - randomly selected on each page load
        const fillerTexts = [
            `<p>Hey friends!</p>
<p>We need to talk about something important: the history of ice cream. Did you know that the ancient Chinese were making frozen milk and rice mixtures as early as 200 BC? Emperor Nero of Rome sent slaves to the mountains to collect snow, which was then flavored with fruits. The man was unhinged, but he had taste.</p>
<p>The first ice cream cone was invented at the 1904 World's Fair when an ice cream vendor ran out of dishes and a nearby waffle maker rolled up his waffles to help. Sometimes the best innovations come from pure desperation and a willingness to put dessert inside other desserts.</p>
<p>Anyway, we've got shows coming up! Check them out below.</p>
<p>Stay frosty,</p>
<p><strong style="font-size: 22px;">House of Hamill</strong></p>`,

            `<p>Dear loyal subscribers,</p>
<p>Today we address a question that has haunted humanity for centuries: how does one make pants for an octopus? The challenges are immense. Eight legs. No hips. A body that can squeeze through any opening larger than its beak. Traditional tailoring simply won't cut it.</p>
<p>Our research suggests a system of interconnected elastic tubes, each with individual drawstrings. The fabric must be waterproof yet breathable, and the whole apparatus needs to accommodate the octopus's ability to change both color AND texture. We're looking at a minimum of 47 buttons.</p>
<p>In unrelated news, we're going on tour! See below for dates.</p>
<p>Eight arms, one dream,</p>
<p><strong style="font-size: 22px;">House of Hamill</strong></p>`,

            `<p>TRAGIC MISHAP MONTHLY: The Official Newsletter of Cursed Destiny, the World's Unluckiest Metal Band</p>
<p>Well, it happened again. Our drummer spontaneously combusted during soundcheck. This is the fourth drummer we've lost this year, and it's only March. The venue is threatening to sue us for "excessive ash damage" to their stage.</p>
<p>Meanwhile, our lead guitarist was struck by lightning INDOORS last Tuesday. He's fine, but his hair is now permanently standing on end and he can only play in the key of B flat. Our bass player's instrument was stolen by a very determined seagull. We don't know how. We don't know why.</p>
<p>Despite everything, the tour continues. Bring umbrellas. And maybe a fire extinguisher.</p>
<p>If we survive,</p>
<p><strong style="font-size: 22px;">House of Hamill</strong></p>`,

            `<p>Greetings, fellow cheese enthusiasts!</p>
<p>This month's newsletter is dedicated to the noble art of cheese rolling. Every year in Gloucestershire, England, brave souls hurl themselves down a nearly vertical hill chasing a 9-pound wheel of Double Gloucester cheese. The cheese can reach speeds of 70 mph. Humans cannot. Injuries are expected and celebrated.</p>
<p>The winner gets to keep the cheese. That's it. That's the prize. A cheese that has been bouncing down a muddy hill for 200 yards while people tumble after it like human tumbleweeds. And yet, people travel from around the world to participate.</p>
<p>This is the kind of energy we bring to our shows. Check the dates below.</p>
<p>Roll with it,</p>
<p><strong style="font-size: 22px;">House of Hamill</strong></p>`,

            `<p>BREAKING NEWS FROM THE PIGEON APPRECIATION SOCIETY</p>
<p>Friends, pigeons don't get the respect they deserve. These birds can find their way home from 1,000 miles away. They were war heroes! They can recognize themselves in mirrors! They mate for life! Meanwhile, we celebrate eagles, who are basically just fancy seagulls with better PR.</p>
<p>A group of pigeons is called a "kit" or a "loft," and honestly, that's adorable. They can see ultraviolet light, which means they experience colors we literally cannot imagine. Every pigeon you see is living in a psychedelic wonderland while we shuffle around in our limited visible spectrum like chumps.</p>
<p>Anyway, come see us play. Tour dates below. No pigeons will be harmed.</p>
<p>Coo coo,</p>
<p><strong style="font-size: 22px;">House of Hamill</strong></p>`,

            `<p>Hello from the void!</p>
<p>Did you know that there's a species of jellyfish that is basically immortal? The Turritopsis dohrnii can revert back to its juvenile form after reaching maturity. It just keeps doing this forever. Scientists call it "biological immortality." We call it "deeply unfair to the rest of us."</p>
<p>Jellyfish have been around for over 500 million years. They have no brain, no heart, and no blood. They're basically just vibes and tentacles, and they've outlasted 99% of all species that ever existed. There's a lesson here somewhere, but we're not sure what it is.</p>
<p>Speaking of floating aimlessly through existence, we're going on tour!</p>
<p>Sting responsibly,</p>
<p><strong style="font-size: 22px;">House of Hamill</strong></p>`,

            `<p>URGENT: A MESSAGE ABOUT SLOTHS</p>
<p>We interrupt your regularly scheduled newsletter to discuss sloths. These magnificent creatures sleep 15-20 hours a day and move so slowly that algae grows on their fur. They've turned laziness into an evolutionary advantage. Predators literally can't see them because they don't register movement.</p>
<p>Sloths only poop once a week, and when they do, they climb all the way down from their tree to do it on the ground. Scientists have no idea why. It's the most dangerous thing they do. Some die doing it. And yet they persist. Respect.</p>
<p>We move slightly faster than sloths on stage. Slightly. Tour dates below.</p>
<p>Slowly but surely,</p>
<p><strong style="font-size: 22px;">House of Hamill</strong></p>`,

            `<p>Dearest Newsletter Enthusiasts,</p>
<p>Today we must discuss the noble potato. This humble tuber was once so feared in Europe that people thought it caused leprosy. France banned potato cultivation for 24 years. The French! Who now eat 30 billion pounds of fries annually!</p>
<p>The potato changed world history more than most wars. It ended famines, fueled industrial revolutions, and gave us vodka. When Marie Antoinette wore potato flowers in her hair to promote the vegetable, it became fashionable overnight. That's right: the potato had a celebrity endorsement deal in the 1780s.</p>
<p>We too hope to one day be as influential as the potato. Until then, we're playing shows.</p>
<p>Starchily yours,</p>
<p><strong style="font-size: 22px;">House of Hamill</strong></p>`,

            `<p>CONFIDENTIAL BRIEFING: THE MANTIS SHRIMP SITUATION</p>
<p>The mantis shrimp can punch with the force of a bullet. Its strike is so fast it boils the water around its claw. Aquariums have to keep them in special reinforced tanks because they've been known to break through glass. This is a real animal that exists on our planet right now.</p>
<p>They can also see 16 types of color receptors. Humans have three. They perceive colors we don't have names for. They're basically tiny, angry, rainbow-seeing murder machines, and they've been around for 400 million years.</p>
<p>Our music is slightly less violent than a mantis shrimp, but we try to bring the same energy. Catch us on tour.</p>
<p>With devastating force,</p>
<p><strong style="font-size: 22px;">House of Hamill</strong></p>`,

            `<p>Friends, Romans, Newsletter Subscribers,</p>
<p>Let us speak of the noble capybara. This giant rodent—the largest in the world—has achieved something remarkable: universal popularity. Every animal likes capybaras. Birds sit on them. Monkeys groom them. Cats cuddle them. They're the only animal that seems to have solved the "being chill" problem completely.</p>
<p>Capybaras can hold their breath for five minutes, sleep in water, and eat their own poop for nutritional purposes. They've figured it out. They're living their best lives in hot springs and nobody can stop them.</p>
<p>We aspire to capybara energy. Come vibe with us at a show.</p>
<p>Radiating chill,</p>
<p><strong style="font-size: 22px;">House of Hamill</strong></p>`,

            `<p>NEWSLETTER FROM THE DEPARTMENT OF BEES</p>
<p>A single bee produces about 1/12th of a teaspoon of honey in its entire lifetime. That's it. Every jar of honey represents the life's work of thousands of tiny flying workers who communicate through interpretive dance. When a bee finds flowers, it goes home and literally dances the directions to its friends.</p>
<p>Bees can recognize human faces. They can count to four. They make democratic decisions by headbutting each other. When the hive gets too hot, some bees stand at the entrance and fan their wings like tiny living air conditioners.</p>
<p>We're not as organized as bees, but we try. Tour dates below.</p>
<p>Buzz buzz,</p>
<p><strong style="font-size: 22px;">House of Hamill</strong></p>`,

            `<p>AN IMPORTANT ANNOUNCEMENT REGARDING WOMBATS</p>
<p>Wombats poop cubes. This is not a joke. Their intestines have special grooves that shape their droppings into stackable cubes. Scientists spent years trying to figure out how. The answer is: weird intestines. The cubes don't roll away, which helps wombats mark their territory.</p>
<p>They also have backwards-facing pouches (so dirt doesn't get in while digging), reinforced rear ends made of cartilage (for blocking predators in their burrows), and they can run 25 mph. They're basically tiny, cube-pooping tanks.</p>
<p>Our shows are not cube-shaped, but they are equally surprising. See you there.</p>
<p>Geometrically yours,</p>
<p><strong style="font-size: 22px;">House of Hamill</strong></p>`,

            `<p>Greetings from the Council of Crows!</p>
<p>Crows hold grudges. Scientists wore masks while being mean to crows, and those crows taught their CHILDREN to hate those masks. Generations of crows, angry at a specific face, forever. They also hold funerals, use tools, and can solve puzzles that stump human toddlers.</p>
<p>A group of crows is called a "murder," which is honestly great branding. They remember faces for years, bring gifts to people who feed them, and have been observed sledding down snowy roofs on makeshift sleds for fun. For fun!</p>
<p>We promise the crows at our shows will not judge you. Tour dates below.</p>
<p>Caw caw,</p>
<p><strong style="font-size: 22px;">House of Hamill</strong></p>`,

            `<p>PUBLIC SERVICE ANNOUNCEMENT: TARDIGRADES</p>
<p>Tardigrades, also known as water bears, are microscopic eight-legged creatures that can survive literally anything. Boiling water? Fine. Frozen solid? Fine. The vacuum of space? FINE. They've survived all five mass extinctions. They'll probably survive the heat death of the universe.</p>
<p>They do this by turning into a dried-out husk called a "tun" and just waiting. For decades if necessary. Add water and they spring back to life like nothing happened. They're basically unkillable gummy bears.</p>
<p>We're not as resilient as tardigrades, but we're trying our best. Come see us while we still exist.</p>
<p>Microscopically,</p>
<p><strong style="font-size: 22px;">House of Hamill</strong></p>`,

            `<p>Dear Fellow Carbon-Based Lifeforms,</p>
<p>Let's talk about the axolotl. This perpetually smiling salamander never grows up—it stays in its larval form forever, like a permanent tadpole with legs. It can regenerate entire limbs, parts of its heart, and even sections of its brain. Scientists are obsessed with it.</p>
<p>Axolotls are critically endangered in the wild but thrive in captivity because they're adorable and people keep adopting them. They're basically Pokémon that accidentally became real. They come in pink, white, gold, and various shades of "how is this a real animal?"</p>
<p>We can't regenerate limbs, but we can play the same songs over and over. Tour dates below.</p>
<p>Regeneratively,</p>
<p><strong style="font-size: 22px;">House of Hamill</strong></p>`,

            `<p>CLASSIFIED: THE PLATYPUS FILES</p>
<p>The platypus is so weird that when European scientists first saw one, they thought it was a hoax—a duck bill sewn onto a beaver. It's a mammal that lays eggs, has venomous spurs, detects prey using electroreception, and sweats milk through its skin because it doesn't have nipples.</p>
<p>The platypus has no stomach. Its bill contains 40,000 electroreceptors. The males have ankle spurs that deliver pain so intense that morphine doesn't help. It glows under blacklight. Every fact about the platypus sounds made up, but they're all true.</p>
<p>Our music makes about as much sense as a platypus. Come experience it live.</p>
<p>Inexplicably,</p>
<p><strong style="font-size: 22px;">House of Hamill</strong></p>`
        ];

        // Select a random filler text
        const defaultContent = fillerTexts[Math.floor(Math.random() * fillerTexts.length)];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initQuillEditor();
            loadData();
            setupPhotoDragDrop();
            updatePhotoPreview();
        });

        function initQuillEditor() {
            quillEditor = new Quill('#body-editor', {
                theme: 'snow',
                placeholder: 'Write your newsletter content here...',
                modules: {
                    toolbar: {
                        container: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'align': [] }],
                            ['link', 'image'],
                            ['clean']
                        ],
                        handlers: {
                            'image': openImageModal
                        }
                    }
                }
            });

            // Set default content
            quillEditor.root.innerHTML = defaultContent;

            // Listen for changes
            quillEditor.on('text-change', () => {
                schedulePreviewUpdate();
            });

            // Setup drag-drop on editor for images
            quillEditor.root.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            quillEditor.root.addEventListener('drop', (e) => {
                e.preventDefault();
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        imageUrlInput.value = event.target.result;
                        updateImageModalPreview();
                        openImageModal();
                    };
                    reader.readAsDataURL(files[0]);
                }
            });
        }

        function getBodyHTML() {
            if (!quillEditor) return '';
            return quillEditor.root.innerHTML;
        }

        // Image modal elements
        const imageModal = document.getElementById('image-modal');
        const imageUrlInput = document.getElementById('image-url-input');
        const imageLinkInput = document.getElementById('image-link-input');
        const imageCaptionInput = document.getElementById('image-caption-input');
        const imageModalDropzone = document.getElementById('image-modal-dropzone');
        const imageModalPreview = document.getElementById('image-modal-preview');

        function openImageModal() {
            imageUrlInput.value = '';
            imageLinkInput.value = '';
            imageCaptionInput.value = '';
            imageModalPreview.style.display = 'none';
            imageModal.classList.remove('hidden');
            // Blur Quill to prevent it from capturing keystrokes
            quillEditor.blur();
            imageUrlInput.focus();
        }

        function closeImageModal() {
            imageModal.classList.add('hidden');
        }

        function updateImageModalPreview() {
            const url = imageUrlInput.value;
            if (url) {
                imageModalPreview.src = url;
                imageModalPreview.style.display = 'block';
            } else {
                imageModalPreview.style.display = 'none';
            }
        }

        async function uploadImage(base64Data) {
            /**
             * Upload a base64 image to the server for resizing and hosting.
             * Returns the URL of the uploaded image.
             */
            try {
                setStatus('loading', 'Uploading image...');
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64Data })
                });
                const result = await response.json();
                if (result.success) {
                    showToast(`Image uploaded (${result.size_kb}KB, ${result.width}x${result.height})`, 'success');
                    setStatus('success', 'Image uploaded');
                    return result.url;
                } else {
                    showToast('Upload failed: ' + result.error, 'error');
                    setStatus('error', 'Upload failed');
                    return null;
                }
            } catch (err) {
                console.error('Upload error:', err);
                showToast('Upload failed', 'error');
                setStatus('error', 'Upload failed');
                return null;
            }
        }

        async function insertImage() {
            let url = imageUrlInput.value.trim();
            const linkUrl = imageLinkInput.value.trim();
            const caption = imageCaptionInput.value.trim();

            if (!url) {
                showToast('Please enter an image URL', 'error');
                return;
            }

            // If it's a base64 data URL, upload it first
            if (url.startsWith('data:')) {
                const uploadedUrl = await uploadImage(url);
                if (!uploadedUrl) return;
                url = uploadedUrl;
            }

            // Build image HTML with optional link and caption - use width attribute for email compatibility
            let imageHtml = `<p style="text-align: center; margin: 20px 0;">`;
            if (linkUrl) {
                imageHtml += `<a href="${linkUrl}" target="_blank" style="text-decoration: none;">`;
            }
            imageHtml += `<img src="${url}" alt="${caption || 'Image'}" width="100%" style="width: 100%; max-width: 620px; height: auto; border-radius: 4px; display: block; margin: 0 auto;">`;
            if (linkUrl) {
                imageHtml += `</a>`;
            }
            if (caption) {
                imageHtml += `<br><em style="font-size: 14px; color: #666; display: block; text-align: center; margin-top: 8px;">${caption}</em>`;
            }
            imageHtml += `</p>`;

            // Insert at cursor position
            const range = quillEditor.getSelection(true);
            quillEditor.clipboard.dangerouslyPasteHTML(range.index, imageHtml);

            closeImageModal();
            schedulePreviewUpdate();
        }

        // Setup image modal drag-drop
        document.addEventListener('DOMContentLoaded', () => {
            imageUrlInput.addEventListener('input', updateImageModalPreview);

            // Prevent keyboard events from bubbling to Quill
            [imageUrlInput, imageLinkInput, imageCaptionInput].forEach(input => {
                input.addEventListener('keydown', (e) => e.stopPropagation());
                input.addEventListener('keyup', (e) => e.stopPropagation());
                input.addEventListener('keypress', (e) => e.stopPropagation());
            });

            imageModalDropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                imageModalDropzone.classList.add('drag-over');
            });

            imageModalDropzone.addEventListener('dragleave', () => {
                imageModalDropzone.classList.remove('drag-over');
            });

            imageModalDropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                imageModalDropzone.classList.remove('drag-over');

                // Check for URL
                const url = e.dataTransfer.getData('text/uri-list') || e.dataTransfer.getData('text/plain');
                if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                    imageUrlInput.value = url;
                    updateImageModalPreview();
                    return;
                }

                // Check for files - read as base64 for preview, will upload on insert
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        imageUrlInput.value = event.target.result;
                        updateImageModalPreview();
                    };
                    reader.readAsDataURL(files[0]);
                }
            });

            // Close modal on backdrop click
            imageModal.addEventListener('click', (e) => {
                if (e.target === imageModal) closeImageModal();
            });
            emailModal.addEventListener('click', (e) => {
                if (e.target === emailModal) closeEmailModal();
            });

            // Close modal on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (!imageModal.classList.contains('hidden')) closeImageModal();
                    if (!emailModal.classList.contains('hidden')) closeEmailModal();
                }
                // Allow Enter to submit email modal
                if (e.key === 'Enter' && !emailModal.classList.contains('hidden')) {
                    e.preventDefault();
                    confirmSendTestEmail();
                }
            });
        });

        // Photo drag-drop setup
        function setupPhotoDragDrop() {
            photoDropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                photoDropZone.classList.add('drag-over');
            });

            photoDropZone.addEventListener('dragleave', () => {
                photoDropZone.classList.remove('drag-over');
            });

            photoDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                photoDropZone.classList.remove('drag-over');

                // Check for URL in text data (dragged from browser)
                const url = e.dataTransfer.getData('text/uri-list') || e.dataTransfer.getData('text/plain');
                if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                    photoUrlInput.value = url;
                    updatePhotoPreview();
                    schedulePreviewUpdate();
                    return;
                }

                // Check for dropped files - upload and resize
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            // Upload the image
                            const uploadedUrl = await uploadImage(event.target.result);
                            if (uploadedUrl) {
                                photoUrlInput.value = uploadedUrl;
                                updatePhotoPreview();
                                schedulePreviewUpdate();
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                }
            });

            // Update preview when URL changes
            photoUrlInput.addEventListener('input', updatePhotoPreview);
        }

        function updatePhotoPreview() {
            const url = photoUrlInput.value;
            if (url) {
                photoPreview.src = url;
                photoPreview.style.display = 'block';
            } else {
                photoPreview.style.display = 'none';
            }
        }

        async function loadData() {
            loadingOverlay.classList.remove('hidden');
            setStatus('loading', 'Loading data...');

            try {
                // Fetch shows, merch, and themes in parallel
                const [showsRes, merchRes, themesRes] = await Promise.all([
                    fetch('/api/shows').then(r => r.json()),
                    fetch('/api/merch').then(r => r.json()),
                    fetch('/api/themes').then(r => r.json())
                ]);

                // Process themes first so preview renders correctly
                if (themesRes.success) {
                    themes = themesRes.themes;
                    populateThemeDropdown();
                }

                // Process shows
                if (showsRes.success) {
                    shows = showsRes.shows;
                    showsCount.textContent = `${shows.length} upcoming shows`;
                    // Generate tour map in the background
                    generateTourMap();
                } else {
                    showsCount.textContent = 'Shows unavailable';
                }

                // Process merch
                if (merchRes.success) {
                    merchItems = merchRes.merch;
                    populateMerchDropdown();
                }

                setStatus('success', 'Ready');
                updatePreview();

            } catch (err) {
                console.error('Error loading data:', err);
                setStatus('error', 'Error loading data');
                showToast('Failed to load data', 'error');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function populateMerchDropdown() {
            merchSelect.innerHTML = '<option value="">-- No merch spotlight --</option>';

            merchItems.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index;
                const saleTag = item.on_sale ? ' (SALE!)' : '';
                option.textContent = `${item.name} - $${item.price}${saleTag}`;
                merchSelect.appendChild(option);
            });

            // Select a random merch item by default
            if (merchItems.length > 0) {
                const randomIndex = Math.floor(Math.random() * merchItems.length);
                merchSelect.value = randomIndex;
                // Update the preview image
                const item = merchItems[randomIndex];
                if (item.image_url) {
                    merchPreviewImg.src = item.image_url;
                    merchPreviewImg.style.display = 'block';
                }
            }
        }

        function populateThemeDropdown() {
            themeSelect.innerHTML = '';

            themes.forEach(theme => {
                const option = document.createElement('option');
                option.value = theme.id;
                option.textContent = theme.name;
                themeSelect.appendChild(option);
            });

            // Select a random theme by default
            if (themes.length > 0) {
                const randomIndex = Math.floor(Math.random() * themes.length);
                selectedTheme = themes[randomIndex].id;
                themeSelect.value = selectedTheme;
                applyThemeColors(selectedTheme);
            }
        }

        function applyThemeColors(themeId) {
            // Find the theme data
            const theme = themes.find(t => t.id === themeId);
            if (!theme || !theme.colors) return;

            const colors = theme.colors;
            const root = document.documentElement;

            // Apply CSS variables for UI theming
            root.style.setProperty('--theme-header-bg', colors.header_bg);
            root.style.setProperty('--theme-header-text', colors.header_text);
            root.style.setProperty('--theme-accent', colors.accent);
            root.style.setProperty('--theme-accent-text', colors.accent_text);
            root.style.setProperty('--theme-body-bg', colors.body_bg);

            // Use distinct ui_bg color for preview panel background
            root.style.setProperty('--theme-preview-bg', colors.ui_bg || colors.footer_bg);
        }

        function schedulePreviewUpdate() {
            // Update merch preview image
            const selectedIndex = merchSelect.value;
            if (selectedIndex !== '' && merchItems[selectedIndex]) {
                const item = merchItems[selectedIndex];
                if (item.image_url) {
                    merchPreviewImg.src = item.image_url;
                    merchPreviewImg.style.display = 'block';
                } else {
                    merchPreviewImg.style.display = 'none';
                }
            } else {
                merchPreviewImg.style.display = 'none';
            }

            // Update selected theme and apply colors immediately
            const newTheme = themeSelect.value;
            if (newTheme !== selectedTheme) {
                selectedTheme = newTheme;
                applyThemeColors(selectedTheme);
            }

            // Debounce preview update
            if (previewTimeout) {
                clearTimeout(previewTimeout);
            }
            previewTimeout = setTimeout(updatePreview, DEBOUNCE_MS);
        }

        async function updatePreview() {
            setStatus('loading', 'Updating preview...');

            const selectedMerch = merchSelect.value !== '' ? merchItems[merchSelect.value] : null;

            const data = {
                subject: subjectInput.value,
                tagline: taglineInput.value || 'Upcycled Celtic Folk',
                body: getBodyHTML(),
                photo_url: photoUrlInput.value || null,
                merch: selectedMerch,
                shows: shows,
                tour_map_url: tourMapUrl,
                theme: selectedTheme,
                include_food_drive: document.getElementById('food-drive-toggle').checked
            };

            try {
                const response = await fetch('/api/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    // Update iframe with new HTML
                    const frameDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                    frameDoc.open();
                    frameDoc.write(result.html);
                    frameDoc.close();
                    // Resize iframe to fit content
                    setTimeout(() => {
                        const contentHeight = frameDoc.body.scrollHeight;
                        previewFrame.style.height = contentHeight + 'px';

                        // When in mobile preview mode, set container height to match scaled content
                        const container = document.getElementById('preview-container');
                        if (container.classList.contains('mobile-preview')) {
                            container.style.height = (contentHeight * 0.514) + 'px';
                        } else {
                            container.style.height = 'auto';
                        }
                    }, 100);
                    setStatus('success', 'Preview updated');
                } else {
                    setStatus('error', 'Preview failed');
                }

            } catch (err) {
                console.error('Preview error:', err);
                setStatus('error', 'Preview error');
            }
        }

        async function copyHTML() {
            setStatus('loading', 'Generating HTML...');

            const selectedMerch = merchSelect.value !== '' ? merchItems[merchSelect.value] : null;

            const data = {
                subject: subjectInput.value,
                tagline: taglineInput.value || 'Upcycled Celtic Folk',
                body: getBodyHTML(),
                photo_url: photoUrlInput.value || null,
                merch: selectedMerch,
                shows: shows,
                tour_map_url: tourMapUrl,
                theme: selectedTheme,
                include_food_drive: document.getElementById('food-drive-toggle').checked
            };

            try {
                const response = await fetch('/api/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    await navigator.clipboard.writeText(result.html);
                    showToast('HTML copied to clipboard!', 'success');
                    setStatus('success', 'Copied!');
                } else {
                    showToast('Failed to generate HTML', 'error');
                    setStatus('error', 'Copy failed');
                }

            } catch (err) {
                console.error('Copy error:', err);
                showToast('Failed to copy to clipboard', 'error');
                setStatus('error', 'Copy failed');
            }
        }

        async function downloadHTML() {
            setStatus('loading', 'Preparing download...');

            const selectedMerch = merchSelect.value !== '' ? merchItems[merchSelect.value] : null;

            const data = {
                subject: subjectInput.value,
                tagline: taglineInput.value || 'Upcycled Celtic Folk',
                body: getBodyHTML(),
                photo_url: photoUrlInput.value || null,
                merch: selectedMerch,
                shows: shows,
                tour_map_url: tourMapUrl,
                theme: selectedTheme,
                include_food_drive: document.getElementById('food-drive-toggle').checked
            };

            try {
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                // Get filename from Content-Disposition header
                const disposition = response.headers.get('Content-Disposition');
                const filename = disposition ? disposition.split('filename=')[1] : 'newsletter.html';

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showToast('Newsletter downloaded!', 'success');
                setStatus('success', 'Downloaded!');

            } catch (err) {
                console.error('Download error:', err);
                showToast('Failed to download', 'error');
                setStatus('error', 'Download failed');
            }
        }

        async function refreshData() {
            try {
                await fetch('/api/refresh');
                showToast('Refreshing data...', 'success');
                loadData();
            } catch (err) {
                showToast('Failed to refresh', 'error');
            }
        }

        async function regenerateTourMap() {
            if (shows.length === 0) {
                showToast('No shows loaded yet', 'error');
                return;
            }

            setStatus('loading', 'Generating HD tour map...');
            showToast('Generating HD map (this may take a moment)...', '');

            try {
                const response = await fetch('/api/generate-hd-map', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shows: shows })
                });

                const result = await response.json();

                if (result.success) {
                    showToast('HD map saved! Now commit & push to deploy.', 'success');
                    setStatus('success', 'Map saved!');

                    // Show instructions
                    alert(`Tour map updated with ${result.locations} locations!\n\nTo deploy to Render, run in terminal:\n\ncd ~/newsletter-builder && git add -A && git commit -m "Update tour map" && git push`);

                    // Refresh to use new map
                    tourMapUrl = '/static/tour_map_hd.png?' + Date.now();
                    updatePreview();
                } else {
                    showToast(result.error || 'Failed to generate map', 'error');
                    setStatus('error', 'Map generation failed');

                    if (result.error && result.error.includes('Cartopy')) {
                        alert('HD map generation requires running locally (not on Render).\n\nRun this on your computer, then commit & push.');
                    }
                }

            } catch (err) {
                console.error('Regenerate map error:', err);
                showToast('Failed to generate map', 'error');
                setStatus('error', 'Map failed');
            }
        }

        // Email modal elements
        const emailModal = document.getElementById('email-modal');
        const emailRecipientInput = document.getElementById('email-recipient-input');

        function sendTestEmail() {
            // Open the email modal instead of sending directly
            emailModal.classList.remove('hidden');
            emailRecipientInput.focus();
            emailRecipientInput.select();
        }

        function closeEmailModal() {
            emailModal.classList.add('hidden');
        }

        async function confirmSendTestEmail() {
            const recipientEmail = emailRecipientInput.value || 'brianhaggis@gmail.com';
            closeEmailModal();

            setStatus('loading', 'Sending test email...');
            showToast(`Sending test email to ${recipientEmail}...`, '');

            const selectedMerch = merchSelect.value !== '' ? merchItems[merchSelect.value] : null;

            const data = {
                subject: subjectInput.value,
                tagline: taglineInput.value || 'Upcycled Celtic Folk',
                body: getBodyHTML(),
                photo_url: photoUrlInput.value || null,
                merch: selectedMerch,
                shows: shows,
                tour_map_url: tourMapUrl,
                theme: selectedTheme,
                include_food_drive: document.getElementById('food-drive-toggle').checked,
                recipient: recipientEmail
            };

            try {
                const response = await fetch('/api/send-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showToast(result.message, 'success');
                    setStatus('success', 'Email sent!');
                } else {
                    showToast(result.error || 'Failed to send email', 'error');
                    setStatus('error', 'Send failed');
                }

            } catch (err) {
                console.error('Send test error:', err);
                showToast('Failed to send test email', 'error');
                setStatus('error', 'Send failed');
            }
        }

        function setStatus(type, text) {
            statusDot.className = 'status-dot ' + type;
            statusText.textContent = text;
        }

        async function generateTourMap() {
            console.log('generateTourMap called, shows:', shows.length);
            if (shows.length === 0) {
                console.log('No shows, skipping map generation');
                return;
            }

            try {
                showToast('Generating tour map...', '');
                console.log('Sending tour-map request...');
                const response = await fetch('/api/tour-map', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shows: shows })
                });

                const result = await response.json();
                console.log('Tour map response:', result);
                if (result.success) {
                    tourMapUrl = result.url;
                    console.log('Tour map URL set to:', tourMapUrl);
                    showToast('Tour map generated!', 'success');
                    updatePreview();
                } else {
                    console.error('Tour map not generated:', result.error);
                    showToast('Map generation failed', 'error');
                }
            } catch (err) {
                console.error('Tour map error:', err);
                showToast('Map generation error', 'error');
            }
        }

        function showToast(message, type = '') {
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Preview mode toggle (desktop/mobile)
        let previewMode = 'desktop';

        function setPreviewMode(mode) {
            previewMode = mode;
            const container = document.getElementById('preview-container');
            const desktopBtn = document.getElementById('preview-desktop');
            const mobileBtn = document.getElementById('preview-mobile');

            if (mode === 'mobile') {
                container.classList.add('mobile-preview');
                desktopBtn.classList.remove('active');
                mobileBtn.classList.add('active');
            } else {
                container.classList.remove('mobile-preview');
                desktopBtn.classList.add('active');
                mobileBtn.classList.remove('active');
            }

            // Re-render preview to adjust iframe height
            updatePreview();
        }

        // Mobile view state
        let currentMobileTab = 'edit';

        function showMobileView(view) {
            const editorPanel = document.querySelector('.editor-panel');
            const previewPanel = document.querySelector('.preview-panel');
            const tabEdit = document.getElementById('tab-edit');
            const tabPreview = document.getElementById('tab-preview');

            currentMobileTab = view;

            if (view === 'edit') {
                editorPanel.classList.remove('hidden-mobile');
                previewPanel.classList.add('hidden-mobile');
                tabEdit.classList.add('active');
                tabPreview.classList.remove('active');
            } else {
                editorPanel.classList.add('hidden-mobile');
                previewPanel.classList.remove('hidden-mobile');
                tabEdit.classList.remove('active');
                tabPreview.classList.add('active');
                // Update preview when switching to preview view
                updatePreview();
            }
        }

        // Smart resize handling - restore both panels on desktop
        function handleResize() {
            const editorPanel = document.querySelector('.editor-panel');
            const previewPanel = document.querySelector('.preview-panel');
            const isMobile = window.innerWidth <= 768;

            if (!isMobile) {
                // Desktop: show both panels
                editorPanel.classList.remove('hidden-mobile');
                previewPanel.classList.remove('hidden-mobile');
            } else {
                // Mobile: apply current tab selection
                showMobileView(currentMobileTab);
            }
        }

        // Listen for resize events
        window.addEventListener('resize', handleResize);
    </script>
</body>
</html>
